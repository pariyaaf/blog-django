{% extends 'base.html'%}
{% load static %}
{% load humanize %}

{% block title %}
| پست
{% endblock title%}

{% block content %}


  <!-- Breadcrumb -->
  <section id="bc" class="mt-3">
    <div class="container">
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% url 'index' %}">خانه</a>
          </li>
          <li class="breadcrumb-item">
            <a href="{% url 'posts' %}">پست ها</a>
          </li>
          <li class="breadcrumb-item active">{{ post.title|truncatechars:20 }}</li>
        </ol>
      </nav>
    </div>
  </section>
  <section>
    <h2 class="text-center"> {{post.title}} </h2>
  </section>

  <!-- Listing -->
  <section id="listing" class="py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <!-- Home Main Image -->
          <img src="{{ post.photo_main.url }}" alt="" class="img-main img-fluid mb-3" />
          <!-- Thumbnails -->
          <div class="row mb-5 thumbs">
            {% if post.photo_2 %}
            <div class="col-md-2">
              <a href="{{ post.photo_2.url }}"  data-lightbox="home-images">
                <img src="{{ post.photo_2.url }}" alt="" class="img-fluid" />
              </a>
            </div>
            {% endif %}
            {% if post.photo_3 %}
            <div class="col-md-2">
              <a href="{{ post.photo_3.url }}"  data-lightbox="home-images">
                <img src="{{ post.photo_3.url }}" alt="" class="img-fluid" />
              </a>
            </div>
            {% endif %}
            {% if post.photo_4 %}
            <div class="col-md-2">
              <a href="{{ post.photo_4.url }}"  data-lightbox="home-images">
                <img src="{{ post.photo_4.url }}" alt="" class="img-fluid" />
              </a>
            </div>
            {% endif %}
            {% if post.photo_5 %}
            <div class="col-md-2">
              <a href="{{ post.photo_5.url }}"  data-lightbox="home-images">
                <img src="{{ post.photo_5.url }}" alt="" class="img-fluid" />
              </a>
            </div>
            {% endif %}
            {% if post.photo_6 %}
            <div class="col-md-2">
              <a href="{{ post.photo_6.url }}"  data-lightbox="home-images">
                <img src="{{ post.photo_6.url }}" alt="" class="img-fluid" />
              </a>
            </div>
            {% endif %}
          </div>
          <!-- Fields -->
          <div class="row mb-5 fields">
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item text-secondary">
                  <i class="fas fa-user"></i>
                  نویسنده:
                  <span>{{post.blogger}}</span>
                </li>
                <li class="list-group-item text-secondary">
                  <i class="fas fa-calendar"></i>
                  تاریخ:
                  <span>{{post.created_at | naturalday}}</span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item text-secondary">
                  <i class="fas fa-thumbs-up" id="like-button" data-liked="{{ liked }}" onclick="toggleLike({{ post.id }})"></i>
                    <span id="likes-count">{{ post.likes.count|intcomma }}</span>
                </li>
                <li class="list-group-item text-secondary">
                  <i class="fas fa-comments"></i>
                  <span>{{post.comments_count | intcomma}}</span>
                </li>
              </ul>
            </div>
          </div>
          <!-- Description -->
          <div class="row mb-5">
            <div class="col-md-12">
              <p style="font-size: 20px;">
                {{post.text}}
              </p>
            </div>
          </div>
        </div>

        <div>
          <h3>کامنت ها</h3>
        </div>
        <!-- Comment Form -->
        <form method="post" id="commentForm" class="mt-4">
          {% csrf_token %}
          <div class="form-group">
              {{ form.non_field_errors }}
              <div class="form-row">
                  <div class="form-col">
                      <label for="{{ form.user_name.id_for_label }}" class="form-label">{{ form.user_name.label }}</label>
                      {{ form.user_name }}
                      {% if form.user_name.help_text %}
                          <small class="form-text">{{ form.user_name.help_text }}</small>
                      {% endif %}
                      {% for error in form.user_name.errors %}
                          <div class="alert">{{ error }}</div>
                      {% endfor %}
                  </div>
                  <div class="form-col">
                      <label for="{{ form.user_email.id_for_label }}" class="form-label">{{ form.user_email.label }}</label>
                      {{ form.user_email }}
                      {% if form.user_email.help_text %}
                          <small class="form-text">{{ form.user_email.help_text }}</small>
                      {% endif %}
                      {% for error in form.user_email.errors %}
                          <div class="alert">{{ error }}</div>
                      {% endfor %}
                  </div>
              </div>
              <div class="form-group">
                  <label for="{{ form.comment_text.id_for_label }}" class="form-label">{{ form.comment_text.label }}</label>
                  {{ form.comment_text }}
                  {% if form.comment_text.help_text %}
                      <small class="form-text">{{ form.comment_text.help_text }}</small>
                  {% endif %}
                  {% for error in form.comment_text.errors %}
                      <div class="alert">{{ error }}</div>
                  {% endfor %}
              </div>
          </div>
          <input type="hidden" id="id_post_id" name="post_id" value="{{ post.id }}">
          <button type="button" onclick="submitForm()" class="btn btn-primary">ارسال کامنت</button>
        </form>
        
        <!-- Comments Section -->
        <ul class="list-group mt-2">
          {% for comment in comments %}
              <li class="list-group-item">
                  <strong>{{ comment.user_name }}</strong>
                  <span class="text-muted"> در {{ comment.comment_date | naturalday }}</span>
                  <p>{{ comment.comment_text }}</p>
              </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>

  # handle like
  <script>
    function toggleLike(postId) {
        $.ajax({
            url: `/like/${postId}/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                var likeButton = $('#like-button');
                $('#likes-count').text(response.likes_count);
            }
        });
    }
  </script>

  # handl comments
  <script>
    function submitForm() {
      var formData = new FormData(document.getElementById('commentForm'));
      formData.append('post', document.getElementById('id_post_id').value);
  
      var xhr = new XMLHttpRequest();
      xhr.open('POST', "{% url 'create_comment' %}");
      xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
              if (xhr.status === 200) {
                  console.log(xhr.responseText);
              } else {
                  console.error('خطا در ارسال فرم');
              }
          }
      };
      xhr.send(formData);
  }
  
  </script>


  {% endblock content %}
